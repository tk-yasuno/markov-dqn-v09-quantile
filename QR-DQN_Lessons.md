# QR-DQN å­¦ç¿’çµæœã‹ã‚‰ã®æ•™è¨“ (v0.9)

**Date:** 2025å¹´12æœˆ11æ—¥ï¼ˆ50kçµæœæ›´æ–°ï¼‰  
**Algorithm:** QR-DQN (Quantile Regression DQN)  
**Reference:** Dabney et al., "Distributional Reinforcement Learning with Quantile Regression" (AAAI 2018)

---

## ğŸ“Š å®Ÿé¨“çµæœã‚µãƒãƒªãƒ¼

| Episodes | None | Work31 | Work33 | Work34 | Work35 | Work38 | **æœ€çµ‚Reward** |
|----------|------|--------|--------|--------|--------|--------|---------------|
| **1k**   | 88.54 | -103.87 | -14.85 | 51.75 | 28.93 | -115.09 | - |
| **5k**   | 126.11 | -101.70 | -12.91 | 72.08 | 59.00 | -126.12 | - |
| **25k**  | 198.94 | 58.39 | 114.11 | 158.00 | 155.70 | 31.89 | - |
| **50k**  | **329.54** | **196.31** | **263.27** | **238.06** | **337.63** | **216.08** | **1299.42** |
| **100k** | 204.73 | 117.55 | 166.79 | 183.43 | 192.88 | 125.91 | **1171.48** |
| **ç·æ”¹å–„** | **+131.3%** | **+213.2%** | **+1223.0%** | **+254.5%** | **+566.7%** | **+209.4%** | - |

*å€¤ã¯å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å¹³å‡æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆmean returnï¼‰*

### ğŸ‰ 50k ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ™‚ç‚¹ã§ã®æˆæœ
- âœ… **å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒ200ä»¥ä¸Šã®ãƒªã‚¿ãƒ¼ãƒ³ã‚’é”æˆ**ï¼ˆ1kã§ã¯3ã¤ãŒè² ã ã£ãŸï¼‰
- âœ… **Work33ãŒæœ€å¤§ã®ç·æ”¹å–„ç‡ï¼ˆ+1873.0%ï¼‰**
- âœ… **Work35ãŒæœ€é«˜ã®å¹³å‡ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆ337.63ï¼‰**
- âœ… **25kâ†’50kã§å¹³å‡+196%ã®æ”¹å–„**
- âœ… **å­¦ç¿’æ™‚é–“: 250.88åˆ†ï¼ˆç´„4.2æ™‚é–“ï¼‰**
- âœ… **æœ€çµ‚å ±é…¬: 1299.42ï¼ˆæœ€å¾Œ100ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å¹³å‡ï¼‰**

### âš ï¸ 100k ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ™‚ç‚¹ã§ã®ç™ºè¦‹ï¼ˆé‡è¦ãªæ•™è¨“ï¼‰
- âš ï¸ **æœ€çµ‚å ±é…¬ãŒ1171.48ã«ä½ä¸‹ï¼ˆ50kã‹ã‚‰-9.8%ï¼‰**
- âš ï¸ **å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å¹³å‡ãƒªã‚¿ãƒ¼ãƒ³ãŒå¤§å¹…ã«ä½ä¸‹**
- âš ï¸ **None: 329.54 â†’ 204.73 (-37.9%)**
- âš ï¸ **Work35: 337.63 â†’ 192.88 (-42.9%)**
- âš ï¸ **Work33: 263.27 â†’ 166.79 (-36.6%)**
- âš ï¸ **å­¦ç¿’æ™‚é–“: 502.36åˆ†ï¼ˆç´„8.4æ™‚é–“ã€50kã®2å€ï¼‰**
- ğŸ“Š **çµè«–: 50k episodeãŒæœ€é©ç‚¹ã€100kã¯éå­¦ç¿’ã®å¯èƒ½æ€§**

### ğŸ”§ 50kæœ€é©åŒ–è¨­å®š
- Learning rate: 1e-3ï¼ˆ25k: 1.5e-3ã‹ã‚‰æ¸›å°‘ï¼‰
- Buffer size: 50,000ï¼ˆ25k: 10,000ã‹ã‚‰5å€å¢—ï¼‰
- Batch size: 128ï¼ˆ25k: 64ã‹ã‚‰2å€å¢—ï¼‰
- Target sync: 1000 stepsï¼ˆ25k: 500ã‹ã‚‰2å€å¢—ï¼‰
- N-step: 3ï¼ˆç¶­æŒï¼‰
- Parallel envs: 16ï¼ˆç¶­æŒï¼‰

---

## ğŸ¯ ä¸»è¦ãªç™ºè¦‹

### 1. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠã®å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³

#### **Noneï¼ˆä½•ã‚‚ã—ãªã„ï¼‰: é«˜ãƒªã‚¿ãƒ¼ãƒ³**
- **1k**: å¹³å‡ 88.54 Â± 384.91
- **5k**: å¹³å‡ 126.11 Â± 439.62
- **25k**: å¹³å‡ 198.94 Â± 297.87
- **50k**: å¹³å‡ **329.54 Â± 403.59**
- **ç·æ”¹å–„**: +272.2%
- **ç‰¹å¾´**: 
  - çŸ­æœŸçš„ã«ã‚³ã‚¹ãƒˆã‚¼ãƒ­ã§é«˜ãƒªã‚¿ãƒ¼ãƒ³
  - Q50ä¸­å¤®å€¤ãŒå¤§å¹…æ”¹å–„ï¼ˆ-5.73 â†’ 110.80 â†’ 209.17 â†’ **321.58**ï¼‰
  - Q05ãŒæ­£ã«å®‰å®šï¼ˆ-183.60 â†’ -141.24 â†’ 11.00 â†’ **-81.17**ï¼‰
  - 50kã§æœ€ã‚‚å®‰å®šã—ãŸé¸æŠè‚¢ã®ä¸€ã¤

#### **Work34ï¼ˆãƒ‡ãƒƒã‚­ä½œæ¥­ï¼‰: å®‰å®šæˆé•·**
- **1k**: å¹³å‡ 51.75 Â± 375.57
- **5k**: å¹³å‡ 72.08 Â± 420.65
- **25k**: å¹³å‡ 158.00 Â± 238.95
- **50k**: å¹³å‡ **238.06 Â± 367.45**
- **ç·æ”¹å–„**: +360.0%
- **ç‰¹å¾´**:
  - å…¨ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§å®‰å®šã—ãŸæˆé•·
  - ã‚³ã‚¹ãƒˆã¨ãƒªã‚¿ãƒ¼ãƒ³ã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„
  - äºˆé˜²ä¿å…¨ã¨ã—ã¦æœ‰åŠ¹

#### **Work35ï¼ˆãƒ‡ãƒƒã‚­äº¤æ›ï¼‰: æœ€é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é”æˆ**
- **1k**: å¹³å‡ 28.93 Â± 397.76
- **5k**: å¹³å‡ 59.00 Â± 445.03
- **25k**: å¹³å‡ 155.70 Â± 256.27
- **50k**: å¹³å‡ **337.63 Â± 392.57**
- **ç·æ”¹å–„**: +1066.8%ï¼ˆç¬¬2ä½ã®æ”¹å–„ç‡ï¼ï¼‰
- **25kâ†’50kæ”¹å–„**: +116.8%
- **ç‰¹å¾´**:
  - **50kã§å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸­æœ€é«˜ã®å¹³å‡ãƒªã‚¿ãƒ¼ãƒ³**
  - Q50ä¸­å¤®å€¤ãŒæœ€é«˜ï¼ˆ**339.23**ï¼‰
  - ä¸­ç¨‹åº¦ã®ã‚³ã‚¹ãƒˆã§æœ€å¤§ã®åŠ¹æœ
  - æœ€ã‚‚æ¨å¥¨ã•ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

#### **Work31ï¼ˆå¤§è¦æ¨¡è£œä¿®ï¼‰: åŠ‡çš„ãªæ”¹å–„ã¨å®‰å®šåŒ–**
- **1k**: å¹³å‡ -103.87 Â± 295.01
- **5k**: å¹³å‡ -101.70 Â± 289.70
- **25k**: å¹³å‡ 58.39 Â± 175.11
- **50k**: å¹³å‡ **196.31 Â± 344.05**
- **ç·æ”¹å–„**: +288.9%ï¼ˆè² ã‹ã‚‰å¤§ããæ­£ã«è»¢æ›ï¼ï¼‰
- **25kâ†’50kæ”¹å–„**: +236.2%ï¼ˆæœ€ã‚‚åŠ‡çš„ãªæ”¹å–„ã®ä¸€ã¤ï¼‰
- **ç‰¹å¾´**:
  - 50kã§200è¿‘ã„ãƒªã‚¿ãƒ¼ãƒ³ã‚’é”æˆ
  - Q50ä¸­å¤®å€¤ãŒå¤§å¹…æ”¹å–„ï¼ˆ-213.73 â†’ 65.40 â†’ **199.22**ï¼‰
  - é«˜ã‚³ã‚¹ãƒˆï¼ˆ2279.69k USDï¼‰ã ãŒé•·æœŸå­¦ç¿’ã§ä¾¡å€¤ã‚’ç™ºè¦‹
  - è¤‡é›‘ãªè£œä¿®æˆ¦ç•¥ã¨ã—ã¦æœ€é©åŒ–
  - é«˜ã‚³ã‚¹ãƒˆï¼ˆ2279.69k USDï¼‰ã ãŒç‰¹å®šçŠ¶æ³ã§æœ‰åŠ¹

#### **Work33ï¼ˆè£œä¿®ï¼‰: æœ€å¤§ã®ç·æ”¹å–„ç‡**
- **1k**: å¹³å‡ -14.85 Â± 363.22
- **5k**: å¹³å‡ -12.91 Â± 380.38
- **25k**: å¹³å‡ 114.11 Â± 243.82
- **50k**: å¹³å‡ **263.27 Â± 372.94**
- **ç·æ”¹å–„**: +1873.0%ï¼ˆå…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸­æœ€å¤§ï¼ï¼‰
- **25kâ†’50kæ”¹å–„**: +130.7%
- **ç‰¹å¾´**:
  - è² ã‹ã‚‰å¤§ãããƒ—ãƒ©ã‚¹ã«è»¢æ›ã—ã€ã•ã‚‰ã«å€å¢—
  - Q50ä¸­å¤®å€¤ãŒå¤§å¹…æ”¹å–„ï¼ˆ-124.92 â†’ 120.88 â†’ **263.77**ï¼‰
  - ä¸­ã‚³ã‚¹ãƒˆã§æœ€ã‚‚åŠ¹æœçš„ãªé¸æŠè‚¢
  - é•·æœŸå­¦ç¿’ã§çœŸã®ä¾¡å€¤ã‚’ç™ºè¦‹

#### **Work38ï¼ˆæ‹¡å¹…å·¥äº‹ï¼‰: é©šç•°çš„ãªå›å¾©**
- **1k**: å¹³å‡ -115.09 Â± 321.98
- **5k**: å¹³å‡ -126.12 Â± 280.09
- **25k**: å¹³å‡ 31.89 Â± 180.53
- **50k**: å¹³å‡ **216.08 Â± 361.30**
- **ç·æ”¹å–„**: +287.8%ï¼ˆè² ã‹ã‚‰å¤§ããæ­£ã«è»¢æ›ï¼ï¼‰
- **25kâ†’50kæ”¹å–„**: +577.6%ï¼ˆæœ€ã‚‚åŠ‡çš„ãªæ”¹å–„ï¼ï¼‰
- **ç‰¹å¾´**:
  - 50kã§200è¶…ãˆã®å¤§å¹…æ”¹å–„
  - Q50ä¸­å¤®å€¤ãŒå¤§å¹…æ”¹å–„ï¼ˆ-199.79 â†’ 13.59 â†’ **205.57**ï¼‰
  - æœ€ã‚‚ã‚³ã‚¹ãƒˆãŒé«˜ã„ï¼ˆ3126.26k USDï¼‰ãŒé•·æœŸå­¦ç¿’ã§ä¾¡å€¤ã‚’ç™ºè¦‹
  - é©åˆ‡ãªä½¿ç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å®Œå…¨ã«å­¦ç¿’

---

## ğŸ“ˆ å­¦ç¿’ã®é€²åŒ–ï¼ˆ1k â†’ 5k â†’ 25k â†’ 50kï¼‰

### åˆ†ä½ç‚¹åˆ†å¸ƒã®æ”¹å–„

#### **1k ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ™‚ç‚¹:**
- åˆ†ä½ç‚¹ãŒã¾ã åºƒãåˆ†æ•£
- å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æœŸå¾…å€¤ãŒä¸å®‰å®š
- Q50ä¸­å¤®å€¤ãŒã»ã¼å…¨ã¦ãƒã‚¤ãƒŠã‚¹

#### **5k ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ™‚ç‚¹:**
- åˆ†ä½ç‚¹åˆ†å¸ƒãŒã‚ˆã‚Šé›†ä¸­
- Noneã€Work34ã€Work35ã§Q50ãŒå¤§å¹…ã«ãƒ—ãƒ©ã‚¹è»¢æ›
- ãƒªã‚¹ã‚¯è©•ä¾¡ï¼ˆVaR/CVaRï¼‰ãŒæ´—ç·´

#### **25k ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ™‚ç‚¹:**
- **å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ—ãƒ©ã‚¹ã®ãƒªã‚¿ãƒ¼ãƒ³ã‚’é”æˆ**
- Work31ã€Work38ãŒè² ã‹ã‚‰æ­£ã«å®Œå…¨è»¢æ›
- Q50ä¸­å¤®å€¤ãŒå…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§æ­£ã«

#### **50k ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ™‚ç‚¹ï¼ˆæœ€æ–°ï¼‰:**
- **å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒ200ä»¥ä¸Šã®ãƒªã‚¿ãƒ¼ãƒ³ã‚’é”æˆ**
- Work35ãŒæœ€é«˜å¹³å‡ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆ337.63ï¼‰ã‚’é”æˆ
- Work38ãŒ25kã‹ã‚‰+577.6%ã®é©šç•°çš„æ”¹å–„
- åˆ†ä½ç‚¹åˆ†å¸ƒãŒå®‰å®šã—ã€ä¸ç¢ºå®Ÿæ€§ãŒé©åˆ‡ã«ç®¡ç†ã•ã‚Œã‚‹

### VaRï¼ˆValue at Riskï¼‰5%ã®æ”¹å–„

| Action | 1k VaR | 5k VaR | 25k VaR | ç·æ”¹å–„ |
|--------|---------|---------|----------|---------|
| None | -498.46 | -421.29 | **-158.59** | **+68.2%** |
| Work31 | -616.47 | -524.31 | **-144.12** | **+76.6%** |
| Work33 | -558.73 | -484.79 | **-120.25** | **+78.5%** |
| Work34 | -490.47 | -436.96 | **-137.28** | **+72.0%** |
| Work35 | -578.59 | -482.98 | **-137.92** | **+76.2%** |
| Work38 | -668.36 | -547.74 | **-198.45** | **+70.3%** |

*ã‚ˆã‚Šé«˜ã„VaR = ã‚ˆã‚Šä½ã„ãƒªã‚¹ã‚¯ï¼ˆ5%ileæ™‚ç‚¹ã§ã®æå¤±ãŒæ¸›å°‘ï¼‰*

### Q50ä¸­å¤®å€¤ã®å®Œå…¨ãªãƒ—ãƒ©ã‚¹è»¢æ›

| Action | 1k Q50 | 5k Q50 | 25k Q50 | å¤‰åŒ– |
|--------|---------|---------|----------|------|
| None | -5.73 | 110.80 | **209.17** | âœ… +214.90 |
| Work31 | -213.73 | -126.48 | **65.40** | âœ… +279.13 |
| Work33 | -124.92 | -38.38 | **120.88** | âœ… +245.80 |
| Work34 | -88.32 | 19.04 | **147.80** | âœ… +236.12 |
| Work35 | -69.29 | 39.35 | **166.53** | âœ… +235.82 |
| Work38 | -260.81 | -176.95 | **19.35** | âœ… +280.16 |

**å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸­å¤®å€¤ãŒãƒ—ãƒ©ã‚¹ã«è»¢æ›ï¼**

---

## ğŸ§  QR-DQNã®åˆ©ç‚¹ï¼ˆC51ã¨ã®æ¯”è¼ƒï¼‰

### 1. **æŸ”è»Ÿãªåˆ†ä½ç‚¹å­¦ç¿’**
- C51: å›ºå®šã•ã‚ŒãŸã‚µãƒãƒ¼ãƒˆ [V_min, V_max]
- QR-DQN: å­¦ç¿’å¯èƒ½ãªåˆ†ä½å€¤
- **åŠ¹æœ**: å®Ÿéš›ã®ãƒªã‚¿ãƒ¼ãƒ³åˆ†å¸ƒã«é©å¿œ

### 2. **Quantile Huber Loss ã®å …ç‰¢æ€§**
- C51: Cross-entropy lossï¼ˆå¤–ã‚Œå€¤ã«æ•æ„Ÿï¼‰
- QR-DQN: Huber lossï¼ˆå¤–ã‚Œå€¤ã«é ‘å¥ï¼‰
- **åŠ¹æœ**: ã‚ˆã‚Šå®‰å®šã—ãŸå­¦ç¿’

### 3. **ç›´æ¥çš„ãªãƒªã‚¹ã‚¯æŒ‡æ¨™**
- åˆ†ä½ç‚¹ã‹ã‚‰ç›´æ¥VaR/CVaRã‚’è¨ˆç®—å¯èƒ½
- ãƒªã‚¹ã‚¯é¸å¥½çš„ãªæ”¿ç­–å­¦ç¿’ãŒå®¹æ˜“

---

## ğŸ’¡ å®Ÿè·µçš„ãªæ•™è¨“

### 1. **å­¦ç¿’ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°ã®é‡è¦æ€§**
- **1k**: åŸºæœ¬çš„ãªå­¦ç¿’å®Œäº†ã€ã—ã‹ã—ä¸å®‰å®š
- **5k**: å®‰å®šåŒ–ã€å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ã«è¿‘ã„
- **25k**: å®Œå…¨åæŸã€å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ—ãƒ©ã‚¹é”æˆ
- **æ¨å¥¨**: æœ€ä½10kä»¥ä¸Šã€ç†æƒ³ã¯**25kä»¥ä¸Š**
- **å®Ÿè¨¼**: 25kã§åŠ‡çš„ãªæ”¹å–„ï¼ˆå¹³å‡+300%ä»¥ä¸Šï¼‰

### 2. **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æˆ¦ç•¥**

#### âœ… **æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ25kå­¦ç¿’å¾Œï¼‰:**
- **None**: çŠ¶æ…‹ãŒè‰¯å¥½ï¼ˆGoodï¼‰ãªå ´åˆï¼ˆå¹³å‡198.94ã€æœ€é«˜ãƒªã‚¿ãƒ¼ãƒ³ï¼‰
- **Work34**: çŠ¶æ…‹ãŒä¸­ç¨‹åº¦ï¼ˆFairï¼‰ã§äºˆé˜²ä¿å…¨ãŒå¿…è¦ãªå ´åˆï¼ˆå¹³å‡158.00ï¼‰
- **Work35**: çŠ¶æ…‹ãŒã‚„ã‚„æ‚ªåŒ–ã—ã¦ããŸå ´åˆã®ä¸­ã‚³ã‚¹ãƒˆå¯¾å¿œï¼ˆå¹³å‡155.70ï¼‰
- **Work33**: ã‚³ã‚¹ãƒˆåŠ¹ç‡çš„ãªè£œä¿®ï¼ˆå¹³å‡114.11ã€+868%æ”¹å–„ï¼ï¼‰

#### âš ï¸ **çŠ¶æ³ã«å¿œã˜ã¦ä½¿ç”¨:**
- **Work31**: æ·±åˆ»ãªåŠ£åŒ–æ™‚ã®å¤§è¦æ¨¡è£œä¿®ï¼ˆå¹³å‡58.39ã€è² ã‹ã‚‰æ­£ã«è»¢æ›ï¼‰
- **Work38**: ç‰¹å®šã®æˆ¦ç•¥çš„çŠ¶æ³ã§ã®æ‹¡å¹…ï¼ˆå¹³å‡31.89ã€å›å¾©ï¼‰

#### â­ **25kå­¦ç¿’ã®é©æ–°:**
å…¨ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ—ãƒ©ã‚¹ã®ãƒªã‚¿ãƒ¼ãƒ³ã‚’é”æˆã—ã€çŠ¶æ³ã«å¿œã˜ãŸæœ€é©ãªé¸æŠãŒå¯èƒ½ã«

### 3. **åˆ†ä½ç‚¹åˆ†å¸ƒã®è§£é‡ˆ**

#### **åºƒã„åˆ†å¸ƒï¼ˆé«˜IQRï¼‰:**
- ä¸ç¢ºå®Ÿæ€§ãŒé«˜ã„
- çŠ¶æ…‹ã‚„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å¤§ããä¾å­˜
- ã‚ˆã‚Šå¤šãã®å­¦ç¿’ãŒå¿…è¦

#### **ç‹­ã„åˆ†å¸ƒï¼ˆä½IQRï¼‰:**
- äºˆæ¸¬ãŒå®‰å®š
- ç¢ºä¿¡åº¦ãŒé«˜ã„
- å®Ÿç”¨çš„ãªæ„æ€æ±ºå®šãŒå¯èƒ½

---

## ğŸ”¬ 25kå­¦ç¿’ã®æˆæœã¨ä»Šå¾Œ

### 1. **25kå­¦ç¿’ã§é”æˆã—ãŸã“ã¨**
- âœ… å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ—ãƒ©ã‚¹ã®ãƒªã‚¿ãƒ¼ãƒ³ã‚’é”æˆ
- âœ… ä¸ç¢ºå®Ÿæ€§ãŒå¤§å¹…ã«å‰Šæ¸›ï¼ˆå¹³å‡-40%ä»¥ä¸Šï¼‰
- âœ… Q05ï¼ˆ5%ileï¼‰ãŒã»ã¼å…¨ã¦ãƒ—ãƒ©ã‚¹ã¾ãŸã¯ã‚¼ãƒ­è¿‘å‚
- âœ… åˆ†ä½ç‚¹åˆ†å¸ƒãŒå®Œå…¨ã«åæŸ
- âœ… å­¦ç¿’æ™‚é–“: ã‚ãšã‹117.68åˆ†ï¼ˆ2æ™‚é–“æœªæº€ï¼‰

### 2. **ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´**
```yaml
# ç¾åœ¨ã®è¨­å®š
n_quantiles: 200    # åˆ†ä½ç‚¹æ•°
kappa: 1.0          # Huberé–¾å€¤
learning_rate: 0.0015
n_envs: 16          # ä¸¦åˆ—ç’°å¢ƒæ•°
```

**æ¤œè¨äº‹é …:**
- `n_quantiles`: 200 â†’ 300 (ã‚ˆã‚Šç´°ã‹ã„åˆ†å¸ƒ)
- `kappa`: 1.0 â†’ 0.5 (ã‚ˆã‚Šé ‘å¥ãªå­¦ç¿’)
- `learning_rate`: å‹•çš„ãªæ¸›è¡°ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### 3. **ãƒªã‚¹ã‚¯é¸å¥½çš„å­¦ç¿’**
CVaRã‚’æœ€é©åŒ–ã™ã‚‹æå¤±é–¢æ•°ã¸ã®å¤‰æ›´:
```python
# CVaRæœ€é©åŒ–ï¼ˆãƒªã‚¹ã‚¯å›é¿çš„ï¼‰
risk_preference = 0.1  # ä¸‹ä½10%ã®ãƒªã‚¹ã‚¯ã‚’é‡è¦–
loss = quantile_huber_loss(...) + Î» * cvar_penalty
```

---

## ğŸ“Š å®šé‡çš„æŒ‡æ¨™ã®æ¨ç§»

### ä¸ç¢ºå®Ÿæ€§ã®å‰Šæ¸›ï¼ˆæ¨™æº–åå·®ï¼‰

| Action | 1k Std | 5k Std | æ”¹å–„ |
|--------|---------|---------|------|
| Work31 | 297.73 | 282.23 | -5.2% |
| Work33 | 332.00 | 324.08 | -2.4% |

*å­¦ç¿’ãŒé€²ã‚€ã«ã¤ã‚Œã¦äºˆæ¸¬ã®ä¸ç¢ºå®Ÿæ€§ãŒæ¸›å°‘*

### IQRï¼ˆInterquartile Rangeï¼‰åˆ†æ

Work34ã®åˆ†ä½ç‚¹ç¯„å›²:
- **1k**: Q25=-149.35, Q75=160.47 â†’ IQR=309.82
- **5k**: Q25=-317.12, Q75=334.16 â†’ IQR=651.28

*ä¸€è¦‹IQRãŒå¢—åŠ ã—ã¦ã„ã‚‹ãŒã€ã“ã‚Œã¯ã‚ˆã‚Šåºƒã„çŠ¶æ…‹ç©ºé–“ã‚’ã‚«ãƒãƒ¼ã—ã¦ã„ã‚‹è¨¼æ‹ *

---

## ğŸ“ QR-DQNå®Ÿè£…ã®æˆåŠŸè¦å› 

### 1. **Noisy Networks**
- Îµ-greedyãªã—ã§åŠ¹æœçš„ãªæ¢ç´¢
- å„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰é–‹å§‹æ™‚ã®ãƒã‚¤ã‚ºãƒªã‚»ãƒƒãƒˆ

### 2. **Mixed Precision Training (AMP)**
- GPUåŠ¹ç‡ã®æœ€å¤§åŒ–
- å­¦ç¿’é€Ÿåº¦ã®å‘ä¸Š

### 3. **Prioritized Experience Replay (PER)**
- é‡è¦ãªé·ç§»ã‚’å„ªå…ˆçš„ã«å­¦ç¿’
- TDèª¤å·®ãƒ™ãƒ¼ã‚¹ã®å„ªå…ˆåº¦ä»˜ã‘

### 4. **N-step Learning (n=3)**
- ã‚ˆã‚Šé•·æœŸçš„ãªå ±é…¬ã‚’è€ƒæ…®
- ãƒã‚¤ã‚¢ã‚¹-åˆ†æ•£ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’æœ€é©åŒ–

### 5. **AsyncVectorEnv (16ä¸¦åˆ—)**
- 16å€ã®å­¦ç¿’é€Ÿåº¦
- å¤šæ§˜ãªçµŒé¨“ã®ä¸¦åˆ—åé›†

---

## ğŸ“ çµè«–

### QR-DQNã®æœ‰åŠ¹æ€§
âœ… **æˆåŠŸã—ãŸç‚¹:**
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¾¡å€¤ã®åˆ†å¸ƒã‚’æ­£ç¢ºã«å­¦ç¿’
- ãƒªã‚¹ã‚¯ã¨ãƒªã‚¿ãƒ¼ãƒ³ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’æ˜ç¢ºåŒ–
- 1kâ†’5kã§å…¨ä½“çš„ã«æ”¹å–„ï¼ˆWork38ä»¥å¤–ï¼‰

âš ï¸ **èª²é¡Œ:**
- Work38ã®ã‚ˆã†ãªæ˜ã‚‰ã‹ã«ä¸åˆ©ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´ãªã‚‹æ”¹å–„
- åˆ†ä½ç‚¹åˆ†å¸ƒã®åæŸã«ã¯ã•ã‚‰ãªã‚‹å­¦ç¿’ãŒå¿…è¦
- é«˜ã‚³ã‚¹ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ä¾¡å€¤è©•ä¾¡ã®ç²¾ç·»åŒ–

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. âœ… **25kå­¦ç¿’å®Œäº†** - å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒæ­£ã®ãƒªã‚¿ãƒ¼ãƒ³ã‚’é”æˆ
2. âœ… **50kå­¦ç¿’å®Œäº†** - å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒ200+ãƒªã‚¿ãƒ¼ãƒ³ã‚’é”æˆ
3. âœ… **ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–å®Ÿé¨“å®Œäº†**
4. **å®Ÿéš›ã®æ©‹æ¢ç®¡ç†ã¸ã®é©ç”¨æ¤œè¨**

---

## ğŸ”¬ ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–å®Ÿé¨“ï¼ˆ50kã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ï¼‰

### å®Ÿé¨“æ¦‚è¦
50kã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§**3ã¤ã®è¨­å®š**ã‚’ç³»çµ±çš„ã«æ¯”è¼ƒã—ã€Learning Rateã®æœ€é©å€¤ã‚’ç‰¹å®šã€‚

### æ¯”è¼ƒè¨­å®š

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å®‰å®šé‡è¦– | æ€§èƒ½é‡è¦– | æœ€é©åŒ–ç‰ˆ |
|----------|---------|---------|---------|
| Learning rate | **1e-3** | 5e-4 | 9e-4 |
| Buffer size | 50,000 | 100,000 | 50,000 |
| Batch size | 128 | 256 | 128 |
| Target sync | 1000 steps | 2000 steps | 1000 steps |

### å®Ÿé¨“çµæœ

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | å®‰å®šé‡è¦– (1e-3) | æ€§èƒ½é‡è¦– (5e-4) | æœ€é©åŒ–ç‰ˆ (9e-4) | å‹è€… |
|----------|----------------|----------------|----------------|------|
| **æœ€çµ‚å ±é…¬** | **1299.42** | 1131.67 | 825.91 | âœ… **å®‰å®šé‡è¦–** |
| **å­¦ç¿’æ™‚é–“** | 250.88åˆ† | 268.09åˆ† | **248.04åˆ†** | âœ… æœ€é©åŒ–ç‰ˆ |
| **å¯¾å®‰å®šé‡è¦–** | - | -12.9% | **-36.4%** | - |
| **é †ä½** | ğŸ¥‡ **1ä½** | ğŸ¥ˆ 2ä½ | ğŸ¥‰ 3ä½ | - |

### ğŸ† çµè«–: å®‰å®šé‡è¦–è¨­å®šãŒåœ§å€’çš„å‹åˆ©

**çµæœã®é †ä½:**
1. ğŸ¥‡ **å®‰å®šé‡è¦– (lr=1e-3)**: 1299.42 - åœ§å€’çš„ãªæ€§èƒ½
2. ğŸ¥ˆ æ€§èƒ½é‡è¦– (lr=5e-4): 1131.67 - 2ä½ï¼ˆ-12.9%ï¼‰
3. ğŸ¥‰ æœ€é©åŒ–ç‰ˆ (lr=9e-4): 825.91 - æœ€ä¸‹ä½ï¼ˆ-36.4%ï¼‰

### ğŸ” é‡è¦ãªç™ºè¦‹: "ä¸­é–“"ãŒæœ€æ‚ªã ã£ãŸ

**ãªãœ9e-4ï¼ˆä¸­é–“å€¤ï¼‰ãŒæœ€ã‚‚æ‚ªã‹ã£ãŸã®ã‹ï¼Ÿ**

#### ä»®èª¬1: ä¸­é€”åŠç«¯ãªå­¦ç¿’ç‡ã®ç½ 
- **1e-3**: ç©æ¥µçš„ãªæ¢ç´¢ â†’ å ±é…¬ç©ºé–“ã®è‰¯ã„é ˜åŸŸã‚’ç™ºè¦‹ âœ…
- **9e-4**: æ¢ç´¢ä¸è¶³ + åæŸã‚‚é…ã„ â†’ **æœ€æ‚ªã®çµ„ã¿åˆã‚ã›** âŒ
- **5e-4**: é…ã„ãŒæ…é‡ â†’ ãã‚Œãªã‚Šã®çµæœ

#### ä»®èª¬2: Learning Rateã®éç·šå½¢åŠ¹æœ
- Learning Rateã®åŠ¹æœã¯**ç·šå½¢ã§ã¯ãªã„**
- 9e-4ã¯æ•°å€¤çš„ã«ã¯ã€Œä¸­é–“ã€ã ãŒã€åŠ¹æœçš„ã«ã¯ã€Œã©ã¡ã‚‰ã®åˆ©ç‚¹ã‚‚å¾—ã‚‰ã‚Œãªã„é ˜åŸŸã€
- ã“ã®å•é¡Œã§ã¯æ˜ç¢ºãªäºŒæ¥µåŒ–: **ç©æ¥µçš„æ¢ç´¢ vs æ…é‡å­¦ç¿’**

#### ä»®èª¬3: æ©‹æ¢ç¶­æŒç®¡ç†å•é¡Œã®ç‰¹æ€§
- è¤‡é›‘ãªçµ„ã¿åˆã‚ã›æœ€é©åŒ–å•é¡Œ
- **ç©æ¥µçš„ãªæ¢ç´¢ãŒå¿…è¦**ï¼ˆå±€æ‰€æœ€é©è§£ãŒå¤šæ•°å­˜åœ¨ï¼‰
- 1e-3ã®æ¢ç´¢åŠ›ãŒå ±é…¬ç©ºé–“ã®è‰¯ã„é ˜åŸŸã‚’ç™ºè¦‹
- 9e-4ã§ã¯æ¢ç´¢ä¸è¶³ã§å±€æ‰€æœ€é©è§£ã«æ•æ‰

### ğŸ“Š é‡è¦ãªæ•™è¨“ï¼ˆæ›´æ–°ç‰ˆï¼‰

> **æ•™è¨“1: "More is not always better"**
> 
> ã‚ˆã‚Šå¤§ããªãƒãƒƒãƒ•ã‚¡ãƒ»ãƒãƒƒãƒã‚µã‚¤ã‚ºãŒå¿…ãšã—ã‚‚è‰¯ã„ã¨ã¯é™ã‚‰ãªã„ã€‚

> **æ•™è¨“2: "ä¸­é–“ãŒæœ€é©ã¨ã¯é™ã‚‰ãªã„"**
> 
> 1e-3ã¨5e-4ã®ä¸­é–“ã®9e-4ãŒæœ€æ‚ªã ã£ãŸã€‚
> ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åŠ¹æœã¯éç·šå½¢ã§ã‚ã‚Šã€ä¸­é–“å€¤ãŒæœ€é©è§£ã¨ã¯é™ã‚‰ãªã„ã€‚
> **å®Ÿé¨“ã«ã‚ˆã‚‹æ¤œè¨¼ãŒä¸å¯æ¬ **ã€‚

> **æ•™è¨“3: "å•é¡Œç‰¹æ€§ã«å¿œã˜ãŸæ¢ç´¢åŠ›ãŒé‡è¦"**
> 
> æ©‹æ¢ç¶­æŒç®¡ç†ã®ã‚ˆã†ãªè¤‡é›‘ãªçµ„ã¿åˆã‚ã›æœ€é©åŒ–å•é¡Œã§ã¯ã€
> ç©æ¥µçš„ãªæ¢ç´¢ï¼ˆlr=1e-3ï¼‰ãŒå±€æ‰€æœ€é©è§£ã‚’å›é¿ã—ã€å„ªã‚ŒãŸæ€§èƒ½ã‚’é”æˆã€‚

### âœ… ç¢ºå®š: æœ€é©è¨­å®šï¼ˆ50kã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ç”¨ï¼‰

```bash
python train_markov_fleet.py \
  --episodes 50000 \
  --n-envs 16 \
  --lr 1e-3              # é©åˆ‡ãªå­¦ç¿’é€Ÿåº¦
  --buffer-size 50000    # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°ã®1å€
  --batch-size 128       # quantilesæ•°ã®0.6å€ç¨‹åº¦
  --target-sync 1000     # é©åº¦ãªæ›´æ–°é »åº¦
  --device cuda
```

### ğŸ”® 100k Episodeå®Ÿé¨“çµæœã¨æ•™è¨“

**100kè¨­å®šï¼ˆå®Ÿè¡Œæ¸ˆã¿ï¼‰:**
```bash
--episodes 100000
--lr 1e-3              # 50kã¨åŒã˜å­¦ç¿’ç‡
--buffer-size 100000   # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°ã®1å€
--batch-size 128       # ç¶­æŒ
--target-sync 1500     # 50kã‚ˆã‚Šé•·ã‚
```

**çµæœ: 50k episodeã‚ˆã‚Šæ€§èƒ½ä½ä¸‹**
- æœ€çµ‚å ±é…¬: 1299.42 (50k) â†’ **1171.48 (100k)** (-9.8%)
- å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å¹³å‡ãƒªã‚¿ãƒ¼ãƒ³ãŒ30-40%ä½ä¸‹

**åŸå› åˆ†æ:**

#### 1. **éå­¦ç¿’ (Overfitting)**
- 50k episodeã§æ—¢ã«æœ€é©è§£ã«åˆ°é”
- 100kã¾ã§ç¶šã‘ã‚‹ã“ã¨ã§ç’°å¢ƒã®ç‰¹å®šãƒ‘ã‚¿ãƒ¼ãƒ³ã«éé©å¿œ
- ä¸€èˆ¬åŒ–æ€§èƒ½ã®ä½ä¸‹

#### 2. **ç ´æ»…çš„å¿˜å´ (Catastrophic Forgetting)**
- ç¶™ç¶šçš„å­¦ç¿’ã«ã‚ˆã‚ŠåˆæœŸã«å­¦ã‚“ã è‰¯ã„æ–¹ç­–ã‚’å¿˜å´
- PERã®å„ªå…ˆåº¦åã‚Šã«ã‚ˆã‚Šå¤ã„çµŒé¨“ã®è»½è¦–
- å›ºå®šå­¦ç¿’ç‡ï¼ˆlr=1e-3ï¼‰ãŒé•·æœŸè¨“ç·´ã§ä¸å®‰å®šåŒ–ã‚’èª˜ç™º

#### 3. **ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºã®å½±éŸ¿**
- ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚º100kãŒå­¦ç¿’ã‚’ä¸å®‰å®šåŒ–
- å¤ã„ã‚µãƒ³ãƒ—ãƒ«ã¨æ–°ã—ã„ã‚µãƒ³ãƒ—ãƒ«ã®æ··åœ¨ã«ã‚ˆã‚‹æ–¹ç­–ã®æŒ¯å‹•

### ğŸ¯ é‡è¦ãªæ•™è¨“4: "More Episodes is Not Always Better"

> **æ•™è¨“4: é•·æœŸè¨“ç·´ã®è½ã¨ã—ç©´**
> 
> ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°ã‚’å¢—ã‚„ã›ã°æ€§èƒ½ãŒå‘ä¸Šã™ã‚‹ã¨ã¯é™ã‚‰ãªã„ã€‚
> - **50k episodeãŒæœ€é©ç‚¹**ï¼ˆæœ€çµ‚å ±é…¬1299.42ï¼‰
> - **100k episodeã§æ€§èƒ½ä½ä¸‹**ï¼ˆæœ€çµ‚å ±é…¬1171.48ã€-9.8%ï¼‰
> - éå­¦ç¿’ã€ç ´æ»…çš„å¿˜å´ã€ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºã®å½±éŸ¿ãŒé¡•åœ¨åŒ–
> - **Early stopping**ã‚„**æ€§èƒ½ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**ã®é‡è¦æ€§ã‚’å®Ÿè¨¼
> - é•·æœŸè¨“ç·´ã«ã¯**å­¦ç¿’ç‡æ¸›è¡°**ã‚„**ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ å­¦ç¿’**ãŒå¿…è¦

**æ¨å¥¨äº‹é …:**
1. **50k episodeã‚’æ¨å¥¨è¨­å®šã¨ã—ã¦æ¡ç”¨**
2. ãã‚Œä»¥ä¸Šã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã¯å­¦ç¿’ç‡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°å¿…é ˆ
3. Validation setã§ã®æ€§èƒ½ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨early stopping
4. Learning rate decay: 1e-3 â†’ 5e-4 (50kä»¥é™)

**75k-100kã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ç”¨ã®æ”¹å–„è¨­å®šï¼ˆä»Šå¾Œã®å®Ÿé¨“ç”¨ï¼‰:**
```bash
--lr-scheduler cosine   # å­¦ç¿’ç‡æ¸›è¡°
--lr-start 1e-3         # åˆæœŸå­¦ç¿’ç‡
--lr-end 5e-4           # æœ€çµ‚å­¦ç¿’ç‡
--buffer-size 75000     # ã‚„ã‚„å°ã•ã‚
--early-stopping        # æ€§èƒ½ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
```

**è¨­è¨ˆåŸå‰‡ï¼ˆæ›´æ–°ç‰ˆï¼‰:**
- **æœ€é©episodeæ•°: 50k**ï¼ˆã“ã®å•é¡Œã§ã¯å®Ÿè¨¼æ¸ˆã¿ï¼‰
- Buffer size â‰ˆ Episodes Ã— 0.5-0.75ï¼ˆå¤§ãã™ãã‚‹ã¨ä¸å®‰å®šï¼‰
- Batch size â‰ˆ N_quantiles Ã— 0.5-0.8
- Target sync â‰ˆ Episodes / 50
- Learning rate: **å›ºå®šlr=1e-3ã¯50kã¾ã§**ã€ãã‚Œä»¥ä¸Šã¯æ¸›è¡°å¿…é ˆ

---

## å‚è€ƒæ–‡çŒ®

1. **QR-DQN:** Dabney, W., et al. "Distributional Reinforcement Learning with Quantile Regression." AAAI 2018.
2. **C51:** Bellemare, M. G., et al. "A Distributional Perspective on Reinforcement Learning." PMLR 2017.
3. **Noisy Networks:** Fortunato, M., et al. "Noisy Networks for Exploration." ICLR 2018.

---

*ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å­¦ç¿’ã®é€²è¡Œã¨ã¨ã‚‚ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚*
